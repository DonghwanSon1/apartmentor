<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="visitCarMapper">

   <resultMap id="visitCarResultSet" type="parking">
      <result column="CAR_NO" property="carNo" />
      <result column="CAR_PHONE" property="carPhone" />
      <result column="STATUS" property="status" />
      <result column="CAR_CATEGORY" property="carCategory" />
      <result column="CAR_DATE" property="carDate" />
      <result column="USER_NO" property="userNo" />
      <result column="CAR_PURPOSE" property="carPurpose" />
      <result column="APT_NO" property="aptNo"/>
   </resultMap>
   
   
   <select id="selectVisitCar" resultType="_int">
      SELECT COUNT(*) 
        FROM PARKING 
       WHERE CAR_NO = #{carNo}
   </select>

   <insert id="enrollVisitCar" parameterType="parking">
      INSERT
        INTO
              PARKING
              (
              CAR_NO,
              CAR_PHONE,
              STATUS,
              CAR_CATEGORY,
              CAR_DATE,
              CAR_PURPOSE,
              USER_NO
              )
      VALUES
            (
            #{carNo},
            #{carPhone},
            'W',
            #{carCategory},
            #{carDate},
            #{carPurpose},
            #{userNo}
            )
   </insert>
   
   <update id="updateVisitCar" parameterType="parking">
      UPDATE 
            PARKING
           SET 
               CAR_PHONE = #{carPhone},
               STATUS = 'W',
                CAR_CATEGORY = #{carCategory},
                CAR_DATE = #{carDate},
                CAR_PURPOSE = #{carPurpose},
                USER_NO = #{userNo}
       WHERE 
             CAR_NO = #{carNo}
   </update>
   
   <update id="setDayVisitCar">
      UPDATE PARKING
           SET STATUS = CASE
           WHEN CAR_DATE = TO_CHAR(SYSDATE, 'YYYY-MM-DD')
           THEN 'Y'
 <![CDATA[WHEN CAR_DATE > TO_CHAR(SYSDATE, 'YYYY-MM-DD')]]>
           THEN 'W'
           ELSE 'N'
          END
   </update>
   
   	<select id="selectVisitCarList" resultMap="visitCarResultSet">
      SELECT CAR_NO, CAR_PHONE, R.STATUS, CAR_CATEGORY, TO_CHAR(CAR_DATE, 'YYYY-MM-DD') AS CAR_DATE, APT_NO, R.USER_NO, CAR_PURPOSE
      FROM PARKING R, MEMBER M
      WHERE R.USER_NO = M.USER_NO
      AND CAR_CATEGORY = 2
      AND M.APT_NO = #{aptNo}
      AND R.STATUS IN('Y','W')
      ORDER BY CAR_DATE ASC
	</select>

   
   <!-- ********************관리자 방문예약 ********************** -->
   <select id="adminVisitCarListCount" resultType="_int">
      SELECT COUNT(*)
      FROM
            PARKING
      WHERE   
            CAR_CATEGORY = 2
   </select>
   
   
   <select id="adminVisitCarList" resultMap="visitCarResultSet">
      SELECT CAR_NO, CAR_PHONE, R.STATUS, CAR_CATEGORY, CAR_DATE, APT_NO, R.USER_NO, CAR_PURPOSE
      FROM PARKING R, MEMBER M
      WHERE R.USER_NO = M.USER_NO
      AND CAR_CATEGORY = 2
      ORDER BY CAR_DATE ASC
   </select>

   <delete id="deleteVisitCar" parameterType="parking">
      DELETE 
      FROM PARKING
      WHERE CAR_NO = #{carNo}
   </delete>

</mapper>